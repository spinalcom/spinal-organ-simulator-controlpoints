"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

let createGraph = (() => {
  var _ref = _asyncToGenerator(function* () {
    const forgeFile = yield window.spinal.spinalSystem.getModel();

    if (!forgeFile.hasOwnProperty("graph")) {
      forgeFile.add_attr({
        graph: new _spinalModelGraph.SpinalGraph()
      });
    }

    return forgeFile.graph;
  });

  return function createGraph() {
    return _ref.apply(this, arguments);
  };
})();

let createContext = (() => {
  var _ref2 = _asyncToGenerator(function* () {
    const graph = yield this.getGraph();
    let context = yield graph.getContext(BIM_OBJECT_CONTEXT_TYPE);

    if (context === undefined) {
      context = new _spinalModelGraph.SpinalContext(BIM_OBJECT_CONTEXT_TYPE);
      yield graph.addContext(context);
    }

    return context;
  });

  return function createContext() {
    return _ref2.apply(this, arguments);
  };
})();

var _spinalModelGraph = require("spinal-model-graph");

var _spinalModelsBimobject = require("spinal-models-bimobject");

var _spinalModelsBimobject2 = _interopRequireDefault(_spinalModelsBimobject);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const BIM_OBJECT_CONTEXT_TYPE = "BIMObjectContext";
const BIM_OBJECT_NODE_TYPE = "BIMObject";
const BIM_OBJECT_RELATION_NAME = "hasBIMObject";
const REFERENCE_OBJECT_RELATION_NAME = "hasReferenceObject";
const BIM_OBJECT_RELATION_TYPE = _spinalModelGraph.SPINAL_RELATION_PTR_LST_TYPE;

const bimObjectService = {
  graph: null,
  context: null,
  getGraph() {
    if (this.graph === null) {
      this.graph = createGraph();
    }

    return this.graph;
  },
  getContext() {
    if (this.context === null) {
      this.context = createContext.call(this);
    }

    return this.context;
  },
  createBIMObject(dbid, name) {
    var _this = this;

    return _asyncToGenerator(function* () {
      let BIMObjNode = yield _this.getBIMObject(dbid);

      if (BIMObjNode === undefined) {
        const BIMObject = new _spinalModelsBimobject2.default(dbid, name);

        BIMObjNode = new _spinalModelGraph.SpinalNode(name, BIM_OBJECT_NODE_TYPE, BIMObject);
        BIMObjNode.info.add_attr({
          dbid: dbid
        });

        const BIMObjectContext = yield _this.getContext();

        yield BIMObjectContext.addChildInContext(BIMObjNode, BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE, BIMObjectContext);
      }

      return BIMObjNode;
    })();
  },
  getBIMObject(dbid) {
    var _this2 = this;

    return _asyncToGenerator(function* () {
      const BIMObjectContext = yield _this2.getContext(BIM_OBJECT_CONTEXT_TYPE);
      const BIMObjectArray = yield BIMObjectContext.getChildren([BIM_OBJECT_RELATION_NAME]);

      for (let BIMObject of BIMObjectArray) {
        if (BIMObject.info.dbid.get() === dbid) {
          return BIMObject;
        }
      }
    })();
  },
  addBIMObject(context, parent, dbId, name) {
    var _this3 = this;

    return _asyncToGenerator(function* () {
      let node;

      if (dbId instanceof _spinalModelGraph.SpinalNode) {
        node = dbId;
      } else {
        node = yield _this3.getBIMObject(dbId);

        if (node === undefined) {
          node = yield _this3.createBIMObject(dbId, name);
        }
      }

      yield parent.addChildInContext(node, BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE, context);

      return node;
    })();
  },
  removeBIMObject(parent, child) {
    return parent.removeChild(child, BIM_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
  },
  deleteBIMObject(dbId) {
    var _this4 = this;

    return _asyncToGenerator(function* () {
      const context = yield _this4.getContext();
      const children = yield context.getChildrenInContext();
      const child = children.find(function (node) {
        return node.info.dbId === dbId;
      });

      if (child === undefined) {
        throw Error("The dbId has no BIM object");
      }

      return child.removeFromGraph();
    })();
  },
  addReferenceObject(parent, dbId, name) {
    var _this5 = this;

    return _asyncToGenerator(function* () {
      let node;

      if (dbId instanceof _spinalModelGraph.SpinalNode) {
        node = dbId;
      } else {
        node = yield _this5.getBIMObject(dbId);

        if (node === undefined) {
          node = yield _this5.createBIMObject(dbId, name);
        }
      }

      yield parent.addChild(node, REFERENCE_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);

      return node;
    })();
  },
  removeReferenceObject(parent, child) {
    return parent.removeChild(child, REFERENCE_OBJECT_RELATION_NAME, BIM_OBJECT_RELATION_TYPE);
  }
};

bimObjectService.constants = {
  BIM_OBJECT_CONTEXT_TYPE,
  BIM_OBJECT_NODE_TYPE,
  BIM_OBJECT_RELATION_NAME,
  REFERENCE_OBJECT_RELATION_NAME,
  BIM_OBJECT_RELATION_TYPE
};

exports.default = bimObjectService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NyZWF0ZUdyYXBoQmltT2JqZWN0LmpzIl0sIm5hbWVzIjpbImZvcmdlRmlsZSIsIndpbmRvdyIsInNwaW5hbCIsInNwaW5hbFN5c3RlbSIsImdldE1vZGVsIiwiaGFzT3duUHJvcGVydHkiLCJhZGRfYXR0ciIsImdyYXBoIiwiU3BpbmFsR3JhcGgiLCJjcmVhdGVHcmFwaCIsImdldEdyYXBoIiwiY29udGV4dCIsImdldENvbnRleHQiLCJCSU1fT0JKRUNUX0NPTlRFWFRfVFlQRSIsInVuZGVmaW5lZCIsIlNwaW5hbENvbnRleHQiLCJhZGRDb250ZXh0IiwiY3JlYXRlQ29udGV4dCIsIkJJTV9PQkpFQ1RfTk9ERV9UWVBFIiwiQklNX09CSkVDVF9SRUxBVElPTl9OQU1FIiwiUkVGRVJFTkNFX09CSkVDVF9SRUxBVElPTl9OQU1FIiwiQklNX09CSkVDVF9SRUxBVElPTl9UWVBFIiwiU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRSIsImJpbU9iamVjdFNlcnZpY2UiLCJjYWxsIiwiY3JlYXRlQklNT2JqZWN0IiwiZGJpZCIsIm5hbWUiLCJCSU1PYmpOb2RlIiwiZ2V0QklNT2JqZWN0IiwiQklNT2JqZWN0IiwiU3BpbmFsQklNT2JqZWN0IiwiU3BpbmFsTm9kZSIsImluZm8iLCJCSU1PYmplY3RDb250ZXh0IiwiYWRkQ2hpbGRJbkNvbnRleHQiLCJCSU1PYmplY3RBcnJheSIsImdldENoaWxkcmVuIiwiZ2V0IiwiYWRkQklNT2JqZWN0IiwicGFyZW50IiwiZGJJZCIsIm5vZGUiLCJyZW1vdmVCSU1PYmplY3QiLCJjaGlsZCIsInJlbW92ZUNoaWxkIiwiZGVsZXRlQklNT2JqZWN0IiwiY2hpbGRyZW4iLCJnZXRDaGlsZHJlbkluQ29udGV4dCIsImZpbmQiLCJFcnJvciIsInJlbW92ZUZyb21HcmFwaCIsImFkZFJlZmVyZW5jZU9iamVjdCIsImFkZENoaWxkIiwicmVtb3ZlUmVmZXJlbmNlT2JqZWN0IiwiY29uc3RhbnRzIl0sIm1hcHBpbmdzIjoiOzs7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akMsRUFBdUNkLElBQXZDLEVBQTZDO0FBQUE7O0FBQUE7QUFDM0MsVUFBSWUsSUFBSjs7QUFFQSxVQUFJRCxnQkFBZ0JULDRCQUFwQixFQUFnQztBQUM5QlUsZUFBT0QsSUFBUDtBQUNELE9BRkQsTUFFTztBQUNMQyxlQUFPLE1BQU0sT0FBS2IsWUFBTCxDQUFrQlksSUFBbEIsQ0FBYjs7QUFFQSxZQUFJQyxTQUFTNUIsU0FBYixFQUF3QjtBQUN0QjRCLGlCQUFPLE1BQU0sT0FBS2pCLGVBQUwsQ0FBcUJnQixJQUFyQixFQUEyQmQsSUFBM0IsQ0FBYjtBQUNEO0FBQ0Y7O0FBRUQsWUFBTWEsT0FBT2EsUUFBUCxDQUNKWCxJQURJLEVBRUp0Qiw4QkFGSSxFQUdKQyx3QkFISSxDQUFOOztBQU1BLGFBQU9xQixJQUFQO0FBbkIyQztBQW9CNUMsR0FoSHNCO0FBaUh2Qlksd0JBQXNCZCxNQUF0QixFQUE4QkksS0FBOUIsRUFBcUM7QUFDbkMsV0FBT0osT0FBT0ssV0FBUCxDQUNMRCxLQURLLEVBRUx4Qiw4QkFGSyxFQUdMQyx3QkFISyxDQUFQO0FBS0Q7QUF2SHNCLENBQXpCOztBQTBIQUUsaUJBQWlCZ0MsU0FBakIsR0FBNkI7QUFDM0IxQyx5QkFEMkI7QUFFM0JLLHNCQUYyQjtBQUczQkMsMEJBSDJCO0FBSTNCQyxnQ0FKMkI7QUFLM0JDO0FBTDJCLENBQTdCOztrQkFRZUUsZ0IiLCJmaWxlIjoiY3JlYXRlR3JhcGhCaW1PYmplY3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBTcGluYWxHcmFwaCxcbiAgU3BpbmFsQ29udGV4dCxcbiAgU3BpbmFsTm9kZSxcbiAgU1BJTkFMX1JFTEFUSU9OX1BUUl9MU1RfVFlQRVxufSBmcm9tIFwic3BpbmFsLW1vZGVsLWdyYXBoXCI7XG5pbXBvcnQgU3BpbmFsQklNT2JqZWN0IGZyb20gXCJzcGluYWwtbW9kZWxzLWJpbW9iamVjdFwiO1xuXG5jb25zdCBCSU1fT0JKRUNUX0NPTlRFWFRfVFlQRSA9IFwiQklNT2JqZWN0Q29udGV4dFwiO1xuY29uc3QgQklNX09CSkVDVF9OT0RFX1RZUEUgPSBcIkJJTU9iamVjdFwiO1xuY29uc3QgQklNX09CSkVDVF9SRUxBVElPTl9OQU1FID0gXCJoYXNCSU1PYmplY3RcIjtcbmNvbnN0IFJFRkVSRU5DRV9PQkpFQ1RfUkVMQVRJT05fTkFNRSA9IFwiaGFzUmVmZXJlbmNlT2JqZWN0XCI7XG5jb25zdCBCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEUgPSBTUElOQUxfUkVMQVRJT05fUFRSX0xTVF9UWVBFO1xuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVHcmFwaCgpIHtcbiAgY29uc3QgZm9yZ2VGaWxlID0gYXdhaXQgd2luZG93LnNwaW5hbC5zcGluYWxTeXN0ZW0uZ2V0TW9kZWwoKTtcblxuICBpZiAoIWZvcmdlRmlsZS5oYXNPd25Qcm9wZXJ0eShcImdyYXBoXCIpKSB7XG4gICAgZm9yZ2VGaWxlLmFkZF9hdHRyKHtcbiAgICAgIGdyYXBoOiBuZXcgU3BpbmFsR3JhcGgoKVxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGZvcmdlRmlsZS5ncmFwaDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQ29udGV4dCgpIHtcbiAgY29uc3QgZ3JhcGggPSBhd2FpdCB0aGlzLmdldEdyYXBoKCk7XG4gIGxldCBjb250ZXh0ID0gYXdhaXQgZ3JhcGguZ2V0Q29udGV4dChCSU1fT0JKRUNUX0NPTlRFWFRfVFlQRSk7XG5cbiAgaWYgKGNvbnRleHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGNvbnRleHQgPSBuZXcgU3BpbmFsQ29udGV4dChCSU1fT0JKRUNUX0NPTlRFWFRfVFlQRSk7XG4gICAgYXdhaXQgZ3JhcGguYWRkQ29udGV4dChjb250ZXh0KTtcbiAgfVxuXG4gIHJldHVybiBjb250ZXh0O1xufVxuXG5jb25zdCBiaW1PYmplY3RTZXJ2aWNlID0ge1xuICBncmFwaDogbnVsbCxcbiAgY29udGV4dDogbnVsbCxcbiAgZ2V0R3JhcGgoKSB7XG4gICAgaWYgKHRoaXMuZ3JhcGggPT09IG51bGwpIHtcbiAgICAgIHRoaXMuZ3JhcGggPSBjcmVhdGVHcmFwaCgpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdyYXBoO1xuICB9LFxuICBnZXRDb250ZXh0KCkge1xuICAgIGlmICh0aGlzLmNvbnRleHQgPT09IG51bGwpIHtcbiAgICAgIHRoaXMuY29udGV4dCA9IGNyZWF0ZUNvbnRleHQuY2FsbCh0aGlzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5jb250ZXh0O1xuICB9LFxuICBhc3luYyBjcmVhdGVCSU1PYmplY3QoZGJpZCwgbmFtZSkge1xuICAgIGxldCBCSU1PYmpOb2RlID0gYXdhaXQgdGhpcy5nZXRCSU1PYmplY3QoZGJpZCk7XG5cbiAgICBpZiAoQklNT2JqTm9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBCSU1PYmplY3QgPSBuZXcgU3BpbmFsQklNT2JqZWN0KGRiaWQsIG5hbWUpO1xuXG4gICAgICBCSU1PYmpOb2RlID0gbmV3IFNwaW5hbE5vZGUobmFtZSwgQklNX09CSkVDVF9OT0RFX1RZUEUsIEJJTU9iamVjdCk7XG4gICAgICBCSU1PYmpOb2RlLmluZm8uYWRkX2F0dHIoe1xuICAgICAgICBkYmlkOiBkYmlkXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgQklNT2JqZWN0Q29udGV4dCA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dCgpO1xuXG4gICAgICBhd2FpdCBCSU1PYmplY3RDb250ZXh0LmFkZENoaWxkSW5Db250ZXh0KFxuICAgICAgICBCSU1PYmpOb2RlLFxuICAgICAgICBCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gICAgICAgIEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRSxcbiAgICAgICAgQklNT2JqZWN0Q29udGV4dFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gQklNT2JqTm9kZTtcbiAgfSxcbiAgYXN5bmMgZ2V0QklNT2JqZWN0KGRiaWQpIHtcbiAgICBjb25zdCBCSU1PYmplY3RDb250ZXh0ID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0KEJJTV9PQkpFQ1RfQ09OVEVYVF9UWVBFKTtcbiAgICBjb25zdCBCSU1PYmplY3RBcnJheSA9IGF3YWl0IEJJTU9iamVjdENvbnRleHQuZ2V0Q2hpbGRyZW4oW1xuICAgICAgQklNX09CSkVDVF9SRUxBVElPTl9OQU1FXG4gICAgXSk7XG5cbiAgICBmb3IgKGxldCBCSU1PYmplY3Qgb2YgQklNT2JqZWN0QXJyYXkpIHtcbiAgICAgIGlmIChCSU1PYmplY3QuaW5mby5kYmlkLmdldCgpID09PSBkYmlkKSB7XG4gICAgICAgIHJldHVybiBCSU1PYmplY3Q7XG4gICAgICB9XG4gICAgfVxuICB9LFxuICBhc3luYyBhZGRCSU1PYmplY3QoY29udGV4dCwgcGFyZW50LCBkYklkLCBuYW1lKSB7XG4gICAgbGV0IG5vZGU7XG5cbiAgICBpZiAoZGJJZCBpbnN0YW5jZW9mIFNwaW5hbE5vZGUpIHtcbiAgICAgIG5vZGUgPSBkYklkO1xuICAgIH0gZWxzZSB7XG4gICAgICBub2RlID0gYXdhaXQgdGhpcy5nZXRCSU1PYmplY3QoZGJJZCk7XG5cbiAgICAgIGlmIChub2RlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbm9kZSA9IGF3YWl0IHRoaXMuY3JlYXRlQklNT2JqZWN0KGRiSWQsIG5hbWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHBhcmVudC5hZGRDaGlsZEluQ29udGV4dChcbiAgICAgIG5vZGUsXG4gICAgICBCSU1fT0JKRUNUX1JFTEFUSU9OX05BTUUsXG4gICAgICBCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEUsXG4gICAgICBjb250ZXh0XG4gICAgKTtcblxuICAgIHJldHVybiBub2RlO1xuICB9LFxuICByZW1vdmVCSU1PYmplY3QocGFyZW50LCBjaGlsZCkge1xuICAgIHJldHVybiBwYXJlbnQucmVtb3ZlQ2hpbGQoXG4gICAgICBjaGlsZCxcbiAgICAgIEJJTV9PQkpFQ1RfUkVMQVRJT05fTkFNRSxcbiAgICAgIEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRVxuICAgICk7XG4gIH0sXG4gIGFzeW5jIGRlbGV0ZUJJTU9iamVjdChkYklkKSB7XG4gICAgY29uc3QgY29udGV4dCA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dCgpO1xuICAgIGNvbnN0IGNoaWxkcmVuID0gYXdhaXQgY29udGV4dC5nZXRDaGlsZHJlbkluQ29udGV4dCgpO1xuICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW4uZmluZChub2RlID0+IG5vZGUuaW5mby5kYklkID09PSBkYklkKTtcblxuICAgIGlmIChjaGlsZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBFcnJvcihcIlRoZSBkYklkIGhhcyBubyBCSU0gb2JqZWN0XCIpO1xuICAgIH1cblxuICAgIHJldHVybiBjaGlsZC5yZW1vdmVGcm9tR3JhcGgoKTtcbiAgfSxcbiAgYXN5bmMgYWRkUmVmZXJlbmNlT2JqZWN0KHBhcmVudCwgZGJJZCwgbmFtZSkge1xuICAgIGxldCBub2RlO1xuXG4gICAgaWYgKGRiSWQgaW5zdGFuY2VvZiBTcGluYWxOb2RlKSB7XG4gICAgICBub2RlID0gZGJJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZSA9IGF3YWl0IHRoaXMuZ2V0QklNT2JqZWN0KGRiSWQpO1xuXG4gICAgICBpZiAobm9kZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG5vZGUgPSBhd2FpdCB0aGlzLmNyZWF0ZUJJTU9iamVjdChkYklkLCBuYW1lKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCBwYXJlbnQuYWRkQ2hpbGQoXG4gICAgICBub2RlLFxuICAgICAgUkVGRVJFTkNFX09CSkVDVF9SRUxBVElPTl9OQU1FLFxuICAgICAgQklNX09CSkVDVF9SRUxBVElPTl9UWVBFXG4gICAgKTtcblxuICAgIHJldHVybiBub2RlO1xuICB9LFxuICByZW1vdmVSZWZlcmVuY2VPYmplY3QocGFyZW50LCBjaGlsZCkge1xuICAgIHJldHVybiBwYXJlbnQucmVtb3ZlQ2hpbGQoXG4gICAgICBjaGlsZCxcbiAgICAgIFJFRkVSRU5DRV9PQkpFQ1RfUkVMQVRJT05fTkFNRSxcbiAgICAgIEJJTV9PQkpFQ1RfUkVMQVRJT05fVFlQRVxuICAgICk7XG4gIH1cbn07XG5cbmJpbU9iamVjdFNlcnZpY2UuY29uc3RhbnRzID0ge1xuICBCSU1fT0JKRUNUX0NPTlRFWFRfVFlQRSxcbiAgQklNX09CSkVDVF9OT0RFX1RZUEUsXG4gIEJJTV9PQkpFQ1RfUkVMQVRJT05fTkFNRSxcbiAgUkVGRVJFTkNFX09CSkVDVF9SRUxBVElPTl9OQU1FLFxuICBCSU1fT0JKRUNUX1JFTEFUSU9OX1RZUEVcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGJpbU9iamVjdFNlcnZpY2U7XG4iXX0=